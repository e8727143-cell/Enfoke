<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF--8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Enfoke</title>
  
  <!-- PWA Meta Tags (sin manifest para evitar 404 en despliegue simple) -->
  <meta name="theme-color" content="#8b5cf6" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Enfoke">

  <!-- Tailwind CSS desde CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  
  <style>
    body {
      font-family: 'Manrope', sans-serif;
      background: linear-gradient(to bottom, #111817, #102220);
      -webkit-tap-highlight-color: transparent;
    }
    @keyframes shimmer-glow {
      0% { transform: translateX(-150%) skewX(-30deg); }
      100% { transform: translateX(150%) skewX(-30deg); }
    }
    .task-item-completed::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 70%;
      height: 100%;
      background: linear-gradient(90deg, rgba(255, 255, 255, 0) 0%, rgba(19, 236, 218, 0.2) 50%, rgba(255, 255, 255, 0) 100%);
      transform: translateX(-150%);
      animation: shimmer-glow 3s ease-in-out infinite;
      animation-delay: 0.5s;
      filter: blur(15px);
    }
    @keyframes fade-in {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .animate-fade-in {
      animation: fade-in 0.3s ease-out forwards;
    }
    @keyframes scale-in {
      from { transform: scale(0.8); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    .animate-scale-in {
      animation: scale-in 0.3s ease-out forwards;
    }
    .time-scroller {
      scroll-snap-type: y mandatory;
      -webkit-mask-image: linear-gradient(to bottom, transparent, black 25%, black 75%, transparent);
      mask-image: linear-gradient(to bottom, transparent, black 25%, black 75%, transparent);
    }
    .time-scroller > div {
      scroll-snap-align: center;
    }
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <!-- Dependencias de Producción (UMD) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <!-- TODA LA APLICACIÓN EN LÍNEA -->
  <script>
    (function () {
      'use strict';

      const { useState, useEffect, useCallback, useRef, Fragment } = React;
      const h = React.createElement;

      // ========== ICON COMPONENTS ==========
      const createSvgIcon = (paths, props = {}) => ({ className }) =>
        h('svg', {
          xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none",
          stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", className, ...props
        }, ...paths);

      const TrashIcon = createSvgIcon([h('path', { key: 1, d: "M3 6h18" }), h('path', { key: 2, d: "M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" }), h('line', { key: 3, x1: "10", y1: "11", x2: "10", y2: "17" }), h('line', { key: 4, x1: "14", y1: "11", x2: "14", y2: "17" })]);
      const PlusIcon = createSvgIcon([h('line', { key: 1, x1: "12", y1: "5", x2: "12", y2: "19" }), h('line', { key: 2, x1: "5", y1: "12", x2: "19", y2: "12" })]);
      const XIcon = createSvgIcon([h('line', { key: 1, x1: "18", y1: "6", x2: "6", y2: "18" }), h('line', { key: 2, x1: "6", y1: "6", x2: "18", y2: "18" })]);
      const CheckIcon = createSvgIcon([h('polyline', { key: 1, points: "20 6 9 17 4 12" })], { strokeWidth: "3" });
      const ClockIcon = createSvgIcon([h('circle', { key: 1, cx: "12", cy: "12", r: "10" }), h('polyline', { key: 2, points: "12 6 12 12 16 14" })]);
      const BrainIcon = ({ className }) => h('svg', { xmlns: "http://www.w3.org/2000/svg", viewBox: "0 0 72 72", className },
        h('path', { fill: "#ffa7c0", d: "M52.482 29.62c-1.251 1.808-.075 3.386 1.104 5.186c1.223 1.868.563 4.303-1.262 5.916a1.353 1.353 0 0 0-.367 1.95c1.242 2.624.357 5.163-2.12 6.738a2.974 2.974 0 0 0-1.117 1.377a4.917 4.917 0 0 1-5.273 3.447a1.902 1.902 0 0 0-1.392.702c-1.422 1.967-3.278 2.355-5.31.918a1.115 1.115 0 0 0-1.553.008c-1.96 1.417-3.89 1.007-5.323-.942a1.925 1.925 0 0 0-1.408-.694a4.72 4.72 0 0 1-5.15-3.371a2.973 2.973 0 0 0-1.12-1.404c-2.651-1.652-3.51-4.269-2.082-7.063c.404-.79.174-1.099-.371-1.576a4.98 4.98 0 0 1-.162-7.77a1.32 1.32 0 0 0 .373-1.753c-1.134-2.796-.305-5.051 2.242-6.69a3.162 3.162 0 0 0 1.147-1.532a4.591 4.591 0 0 1 4.98-3.201a1.446 1.446 0 0 0 1.664-.79a3.38 3.38 0 0 1 5.09-.991a1.227 1.227 0 0 0 1.765.012c1.877-1.348 3.824-.89 5.212.99a2.048 2.048 0 0 0 1.505.73a4.864 4.864 0 0 1 5.183 3.558a3.24 3.24 0 0 0 1.283 1.416a5.234 5.234 0 0 1 2.462 4.828Z" }),
        h('g', { fill: "none", stroke: "#000", strokeWidth: "2" },
            h('path', { strokeMiterlimit: "10", d: "M52.482 29.62c-1.251 1.808-.075 3.386 1.104 5.186c1.223 1.868.563 4.303-1.262 5.916a1.353 1.353 0 0 0-.367 1.95c1.242 2.624.357 5.163-2.12 6.738a2.974 2.974 0 0 0-1.117 1.377a4.917 4.917 0 0 1-5.273 3.447a1.902 1.902 0 0 0-1.392.702c-1.422 1.967-3.278 2.355-5.31.918a1.115 1.115 0 0 0-1.553.008c-1.96 1.417-3.89 1.007-5.323-.942a1.925 1.925 0 0 0-1.408-.694a4.72 4.72 0 0 1-5.15-3.371a2.973 2.973 0 0 0-1.12-1.404c-2.651-1.652-3.51-4.269-2.082-7.063c.404-.79.174-1.099-.371-1.576a4.98 4.98 0 0 1-.162-7.77a1.32 1.32 0 0 0 .373-1.753c-1.134-2.796-.305-5.051 2.242-6.69a3.162 3.162 0 0 0 1.147-1.532a4.591 4.591 0 0 1 4.98-3.201a1.446 1.446 0 0 0 1.664-.79a3.38 3.38 0 0 1 5.09-.991a1.227 1.227 0 0 0 1.765.012c1.877-1.348 3.824-.89 5.212.99a2.048 2.048 0 0 0 1.505.73a4.864 4.864 0 0 1 5.183 3.558a3.24 3.24 0 0 0 1.283 1.416a5.234 5.234 0 0 1 2.462 4.828ZM36 18.461v37.084" }),
            h('path', { strokeLinecap: "round", strokeLinejoin: "round", d: "M30.675 30.061s3.923-3.944 5.325 1.352m5.325-1.352S37.402 26.117 36 31.413m8.122-4.336s2.659-4.887-2.817-4.717m.02 20.54S37.402 46.846 36 41.55m6.312-5.049s3.96-3.908 5.313 1.4M30.675 42.9s3.923 3.945 5.325-1.35" }),
            h('path', { strokeLinecap: "round", strokeLinejoin: "round", d: "M50.02 24.79s-1.258-1.334-5.298-1.009m-.659 22.808s2.214 5.104-3.225 4.448" }),
            h('path', { strokeLinecap: "round", strokeLinejoin: "round", d: "M49.98 49.317s-1.617 1.292-5.612.608M28.085 27.077s-2.66-4.887 2.817-4.717M29.2 36.501s-3.96-3.908-5.312 1.4" }),
            h('path', { strokeLinecap: "round", strokeLinejoin: "round", d: "M22.137 24.634s1.308-1.178 5.348-.853m.405 22.808s-2.214 5.104 3.225 4.448" }),
            h('path', { strokeLinecap: "round", strokeLinejoin: "round", d: "M21.973 49.317s1.617 1.292 5.612.608" })
        )
      );
      
      // ========== UI COMPONENTS ==========
      function CelebrationAnimation({ show }) {
        if (!show) return null;
        return h('div', { className: `fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-[100] transition-opacity duration-300 ${show ? 'opacity-100 animate-fade-in' : 'opacity-0'}` },
          h('div', { className: "flex flex-col items-center justify-center transform transition-transform duration-300 scale-100 animate-scale-in" },
            h('h2', { className: "text-4xl sm:text-6xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 to-amber-500 mt-4 drop-shadow-lg", style: { textShadow: '0 2px 4px rgba(0,0,0,0.5)' } }, '¡Felicidades!')
          )
        );
      }
      
      function TimeSelector({ isOpen, onClose, onTimeSelect, initialTime }) {
        const [selectedHour, setSelectedHour] = useState('09');
        const [selectedMinute, setSelectedMinute] = useState('00');
        const hourScrollerRef = useRef(null);
        const minuteScrollerRef = useRef(null);
        const hours = Array.from({ length: 24 }, (_, i) => String(i).padStart(2, '0'));
        const minutes = Array.from({ length: 12 }, (_, i) => String(i * 5).padStart(2, '0'));

        useEffect(() => {
          if (initialTime) {
            const [h, m] = initialTime.split(':');
            setSelectedHour(h);
            setSelectedMinute(String(Math.round(parseInt(m, 10) / 5) * 5).padStart(2, '0'));
          } else { setSelectedHour('09'); setSelectedMinute('00'); }
        }, [initialTime, isOpen]);
        
        useEffect(() => {
          if (isOpen && hourScrollerRef.current && minuteScrollerRef.current) {
            const itemHeight = 48; // h-12
            hourScrollerRef.current.scrollTop = hours.indexOf(selectedHour) * itemHeight;
            minuteScrollerRef.current.scrollTop = minutes.indexOf(selectedMinute) * itemHeight;
          }
        }, [isOpen, selectedHour, selectedMinute]);

        if (!isOpen) return null;

        const handleScroll = (e, type) => {
          const itemHeight = 48;
          const index = Math.round(e.currentTarget.scrollTop / itemHeight);
          if (type === 'hour') setSelectedHour(hours[index]);
          else setSelectedMinute(minutes[index]);
        };

        return h('div', { className: "fixed inset-0 bg-black/70 backdrop-blur-sm flex items-end sm:items-center justify-center z-50 p-4 animate-fade-in", onClick: onClose },
          h('div', { className: "bg-slate-800 rounded-2xl shadow-2xl w-full max-w-sm flex flex-col border border-slate-700 animate-scale-in", onClick: e => e.stopPropagation() },
            h('header', { className: "flex items-center justify-between p-4 border-b border-slate-700" },
              h('h2', { className: "text-xl font-semibold text-slate-100" }, 'Seleccionar Hora'),
              h('button', { onClick: onClose, className: "p-2 rounded-full text-slate-400 hover:bg-slate-700" }, h(XIcon, { className: 'w-6 h-6' }))
            ),
            h('div', { className: "relative flex justify-center items-center h-48 my-4 text-2xl text-slate-100" },
              h('div', { className: "absolute inset-x-4 h-12 top-1/2 -translate-y-1/2 bg-teal-500/10 rounded-lg border border-teal-500/30" }),
              h('div', { ref: hourScrollerRef, onScroll: e => handleScroll(e, 'hour'), className: "time-scroller w-1/2 h-full overflow-y-scroll scrollbar-hide" },
                h('div', { className: 'h-[72px]' }),
                ...hours.map(hr => h('div', { key: hr, className: `flex items-center justify-center h-12 transition-all ${selectedHour === hr ? 'text-teal-300 font-bold text-3xl' : 'text-slate-500'}` }, hr)),
                h('div', { className: 'h-[72px]' })
              ),
              h('div', { className: 'text-4xl text-slate-500' }, ':'),
              h('div', { ref: minuteScrollerRef, onScroll: e => handleScroll(e, 'minute'), className: "time-scroller w-1/2 h-full overflow-y-scroll scrollbar-hide" },
                h('div', { className: 'h-[72px]' }),
                ...minutes.map(m => h('div', { key: m, className: `flex items-center justify-center h-12 transition-all ${selectedMinute === m ? 'text-teal-300 font-bold text-3xl' : 'text-slate-500'}` }, m)),
                h('div', { className: 'h-[72px]' })
              )
            ),
            h('div', { className: "p-4 border-t border-slate-700" },
              h('button', { onClick: () => onTimeSelect(`${selectedHour}:${selectedMinute}`), className: "w-full py-3 bg-teal-600 text-white rounded-lg font-semibold hover:bg-teal-500" }, 'Confirmar')
            )
          )
        );
      }
      
      function TaskItem({ task, onToggle, onDelete, onSetImportance, onSetTime }) {
        const [isTimeSelectorOpen, setIsTimeSelectorOpen] = useState(false);
        const importanceClasses = { normal: 'bg-transparent', important: 'bg-yellow-500', urgent: 'bg-red-500' };
        const importanceSequence = ['normal', 'important', 'urgent'];
        const handleImportanceClick = () => {
          const nextIndex = (importanceSequence.indexOf(task.importance || 'normal') + 1) % 3;
          onSetImportance(task.id, importanceSequence[nextIndex]);
        };
        
        return h(Fragment, null,
          h('div', { className: "flex items-center gap-2" },
            h('button', { onClick: handleImportanceClick, className: `w-1.5 h-16 rounded-full transition-all duration-300 ${importanceClasses[task.importance || 'normal']}` }),
            h('div', { className: "flex-grow flex flex-col" },
              !task.completed && task.importance !== 'normal' && h('span', { className: `text-xs font-bold uppercase mb-1 ml-4 self-start ${task.importance === 'urgent' ? 'text-red-400/80' : 'text-yellow-400/80'}` }, task.importance),
              h('div', { className: `relative flex items-center p-4 bg-white/5 rounded-xl group transition-all overflow-hidden ${task.completed ? 'bg-[#13ecda]/10 task-item-completed' : ''}` },
                h('button', { onClick: () => onToggle(task.id), className: `flex-shrink-0 h-7 w-7 border-2 rounded-full flex items-center justify-center ${task.completed ? 'bg-[#13ecda] border-[#13ecda]/80' : 'border-[#13ecda]'}` },
                  task.completed && h(CheckIcon, { className: 'h-4 w-4 text-white' })
                ),
                h('div', { className: 'ml-4 flex-grow min-w-0' },
                  h('span', { className: `text-lg text-slate-100 block truncate ${task.completed ? 'line-through text-slate-400' : ''}` }, task.text),
                  task.time && h('span', { className: 'text-sm text-[#13ecda]/80 font-semibold' }, task.time)
                ),
                h('div', { className: "flex items-center gap-2 opacity-0 group-hover:opacity-100" },
                  h('button', { onClick: () => setIsTimeSelectorOpen(true), className: 'text-slate-500 hover:text-[#13ecda]' }, h(ClockIcon, { className: 'h-5 w-5' })),
                  h('button', { onClick: () => onDelete(task.id), className: 'text-slate-500 hover:text-red-400' }, h(TrashIcon, { className: 'h-6 w-6' }))
                )
              )
            )
          ),
          h(TimeSelector, { isOpen: isTimeSelectorOpen, onClose: () => setIsTimeSelectorOpen(false), onTimeSelect: (time) => { onSetTime(task.id, time); setIsTimeSelectorOpen(false); }, initialTime: task.time })
        );
      }
      
      function SuggestedTasksModal({ isOpen, onClose, onConfirm, suggestions }) {
        const [selectedTask, setSelectedTask] = useState(null);
        const [importance, setImportance] = useState('normal');
        const [time, setTime] = useState('');
        const [isTimeSelectorOpen, setIsTimeSelectorOpen] = useState(false);
        const importanceStyles = { normal: 'border-slate-600', important: 'border-yellow-500', urgent: 'border-red-500' };

        useEffect(() => { if (!isOpen) { setSelectedTask(null); setImportance('normal'); setTime(''); } }, [isOpen]);

        if (!isOpen) return null;

        const mainContent = !selectedTask
          ? h('div', { className: "p-4 overflow-y-auto space-y-3" },
              suggestions.map(text => h('button', { key: text, onClick: () => setSelectedTask(text), className: "w-full flex items-center gap-4 text-left p-4 bg-slate-700/50 rounded-lg hover:bg-teal-500/30 text-slate-100" },
                h('span', { className: 'text-lg' }, text)
              ))
            )
          : h('div', { className: "p-6 overflow-y-auto flex flex-col gap-6" },
              h('p', { className: "text-lg text-center text-slate-300 bg-slate-700/50 p-3 rounded-lg" }, selectedTask),
              h('div', null,
                h('label', { className: 'block text-sm text-slate-400 mb-2' }, 'Importancia'),
                h('div', { className: 'grid grid-cols-3 gap-3' },
                  ['normal', 'important', 'urgent'].map(level => h('button', { key: level, onClick: () => setImportance(level), className: `p-3 rounded-lg border-2 ${importance === level ? importanceStyles[level] + ' bg-white/10' : 'border-transparent bg-slate-700/50'}` }, level.charAt(0).toUpperCase() + level.slice(1)))
                )
              ),
              h('div', null,
                h('label', { className: 'block text-sm text-slate-400 mb-2' }, 'Hora (Opcional)'),
                h('button', { onClick: () => setIsTimeSelectorOpen(true), className: 'w-full bg-slate-900/80 rounded-md px-3 py-2 text-lg border border-slate-700 flex justify-between items-center' },
                  h('span', { className: time ? 'text-white' : 'text-slate-500' }, time || 'Definir hora'),
                  h(ClockIcon, { className: 'w-5 h-5 text-slate-400' })
                )
              ),
              h('div', { className: "flex items-center gap-3 pt-4 border-t border-slate-700" },
                h('button', { onClick: () => setSelectedTask(null), className: "w-full py-3 bg-slate-700 rounded-lg" }, 'Atrás'),
                h('button', { onClick: () => onConfirm({ text: selectedTask, importance, time: time || null }), className: "w-full py-3 bg-teal-600 text-white rounded-lg" }, 'Añadir Tarea')
              )
            );

        return h('div', { className: "fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-fade-in", onClick: onClose },
          h('div', { className: "bg-slate-800 rounded-2xl shadow-2xl w-full max-w-md max-h-[90vh] flex flex-col border border-slate-700 animate-scale-in", onClick: e => e.stopPropagation() },
            h('header', { className: 'flex items-center justify-between p-4 border-b border-slate-700' },
              h('h2', { className: 'text-xl font-semibold text-slate-100' }, selectedTask ? 'Configurar Tarea' : 'Elige una Tarea'),
              h('button', { onClick: onClose, className: 'p-2 rounded-full text-slate-400 hover:bg-slate-700' }, h(XIcon, { className: 'w-6 h-6' }))
            ),
            mainContent,
            h(TimeSelector, { isOpen: isTimeSelectorOpen, onClose: () => setIsTimeSelectorOpen(false), onTimeSelect: (t) => { setTime(t); setIsTimeSelectorOpen(false); }, initialTime: time })
          )
        );
      }
      
      function TreeIcon({ className }) {
        return h('svg', { xmlns: "http://www.w3.org/2000/svg", viewBox: "0 0 72 72", className },
            h('path', { fill: "#b1cc33", d: "M51.56 17.73c-.509.003-1.018.034-1.524.091l-.673.072l-.317-.6c-2.673-5.047-8.5-8.308-14.854-8.308c-9.026 0-16.369 6.4-16.369 14.268c.002.517.035 1.032.1 1.544l.1.824l-.792.251c-4.015 1.272-6.608 4.186-6.608 7.421c0 4.445 4.851 8.061 10.813 8.061a13.17 13.17 0 0 0 6.584-1.688l.591-.34l.19.15l.343.275c2.714 2.167 7.082 3.462 11.683 3.462c7.763 0 14.32-3.69 14.32-8.06a4.411 4.411 0 0 0-.077-.806l-.139-.75l-.021-.118l.842-.266c4.021-1.27 6.621-4.185 6.621-7.425c.002-4.439-4.85-8.058-10.813-8.058z" }),
            h('path', { fill: "#5c9e31", d: "M39.468 27.997s4.917 7.331 15.443 5.488l.891 3.572l-4 4.922l-9.214 2.032l-12.13-2.555l-1.846-2.126A17.56 17.56 0 0 0 39.47 27.997z" }),
            h('g', { fill: "none", stroke: "#000", strokeLinecap: "round", strokeWidth: "2" },
                h('path', { strokeLinejoin: "round", d: "M35.789 63.943V52.776l-7.63-7.516m7.63 7.516l4.368-4.546" }),
                h('path', { strokeMiterlimit: "10", d: "M63.374 25.773c0-5-5.289-9.06-11.813-9.06a15.38 15.38 0 0 0-1.63.1c-2.764-5.217-8.763-8.84-15.739-8.84c-9.593 0-17.369 6.836-17.369 15.268c.002.558.038 1.114.108 1.667c-4.288 1.36-7.306 4.595-7.306 8.374c0 5 5.29 9.061 11.813 9.061c2.48.021 4.922-.607 7.084-1.822c2.791 2.23 7.257 3.681 12.307 3.681c8.461 0 15.32-4.057 15.32-9.06a5.464 5.464 0 0 0-.094-.987c4.294-1.36 7.32-4.598 7.32-8.382z" })
            )
        );
      }

      function ActiveTimerScreen({ timeLeft, duration, onStop }) {
        const radius = 56;
        const circumference = 2 * Math.PI * radius;
        const progress = duration > 0 ? (timeLeft / duration) : 0;
        const strokeDashoffset = circumference * (1 - progress);

        const formatTime = (seconds) => {
            const mins = String(Math.floor(seconds / 60)).padStart(2, '0');
            const secs = String(seconds % 60).padStart(2, '0');
            return `${mins}:${secs}`;
        };

        return h('div', { className: 'relative flex h-full w-full flex-col bg-gradient-to-br from-[#43A047] to-[#00796B]' },
            h('header', { className: 'h-16 flex-shrink-0' }),
            h('main', { className: 'flex flex-grow flex-col items-center justify-center p-6 text-center text-white' },
                h('div', { className: 'relative flex h-80 w-80 items-center justify-center' },
                    h('svg', { className: 'h-full w-full', viewBox: '0 0 120 120' },
                        h('circle', { className: 'text-white/20', cx: 60, cy: 60, fill: 'transparent', r: radius, stroke: 'currentColor', strokeWidth: 8 }),
                        h('circle', {
                            className: 'text-white',
                            style: {
                                transition: 'stroke-dashoffset 0.35s',
                                transform: 'rotate(-90deg)',
                                transformOrigin: '50% 50%',
                                strokeDasharray: circumference,
                                strokeDashoffset: strokeDashoffset
                            },
                            cx: 60, cy: 60, fill: 'transparent', r: radius, stroke: 'currentColor', strokeLinecap: 'round', strokeWidth: 8
                        })
                    ),
                    h('div', { className: 'absolute flex flex-col items-center justify-center' },
                        h(TreeIcon, { className: 'w-24 h-24' }),
                        h('p', { className: 'mt-2 text-5xl font-bold tracking-tight text-white' }, formatTime(timeLeft))
                    )
                ),
                h('p', { className: 'mt-8 text-lg font-normal leading-normal text-white/90' }, 'Sesión en curso')
            ),
            h('footer', { className: 'flex flex-shrink-0 items-center justify-center p-8 pb-12' },
                h('button', {
                    onClick: onStop,
                    className: 'flex h-20 w-20 cursor-pointer items-center justify-center overflow-hidden rounded-full bg-white text-[#111817] shadow-lg transition-transform duration-200 ease-in-out hover:scale-105 active:scale-95'
                },
                    h('span', { className: 'material-symbols-outlined text-[#00796B]', style: { fontSize: '40px' } }, 'stop')
                )
            )
        );
      }


      function FocusTimer({ isOpen, onClose }) {
        const SUPABASE_URL = 'https://diksvhkjuexnyoqlrbjz.supabase.co/storage/v1/object/public/audio_assets';
        const sounds = [
            { name: 'Lluvia', file: 'light-rain.mp3', icon: 'water_drop' },
            { name: 'Bosque', file: 'forest.mp3', icon: 'forest' },
            { name: 'Olas', file: 'waves.mp3', icon: 'waves' },
            { name: 'Fuego', file: 'fireplace.mp3', icon: 'local_fire_department' },
            { name: 'Cafetería', file: 'cafe-ambience.mp3', icon: 'coffee' },
            { name: 'Viento', file: 'wind.mp3', icon: 'air' },
            { name: 'Noche', file: 'night-ambience.mp3', icon: 'raven' },
            { name: 'LoFi', file: 'lofi-chill.mp3', icon: 'thunderstorm' },
            { name: 'Río', file: 'calm-river.mp3', icon: 'graphic_eq' }
        ];

        const [duration, setDuration] = useState(25 * 60);
        const [timeLeft, setTimeLeft] = useState(duration);
        const [isRunning, setIsRunning] = useState(false);
        const [activeSound, setActiveSound] = useState(null);

        const audioRef = useRef(null);
        const endTimerAudioRef = useRef(null);
        const intervalRef = useRef(null);
        const dragStartRef = useRef({ y: 0, duration: 0 });

        useEffect(() => {
          if (isRunning) {
            intervalRef.current = setInterval(() => {
              setTimeLeft(prev => {
                if (prev <= 1) {
                  clearInterval(intervalRef.current);
                  setIsRunning(false);
                  if (audioRef.current) audioRef.current.pause();
                  if (endTimerAudioRef.current) {
                    endTimerAudioRef.current.play().catch(e => console.error("Error playing end timer sound:", e));
                  }
                  return 0;
                }
                return prev - 1;
              });
            }, 1000);
          } else {
            clearInterval(intervalRef.current);
          }
          return () => clearInterval(intervalRef.current);
        }, [isRunning]);
        
        useEffect(() => {
          if (!isRunning) setTimeLeft(duration);
        }, [duration]);

        useEffect(() => {
            if (!isOpen) {
              setIsRunning(false);
              if (audioRef.current) audioRef.current.pause();
              setActiveSound(null);
            }
        }, [isOpen]);

        const formatTime = (seconds) => {
          const mins = String(Math.floor(seconds / 60)).padStart(2, '0');
          const secs = String(seconds % 60).padStart(2, '0');
          return `${mins}:${secs}`;
        };
        
        const handleStop = () => {
          setIsRunning(false);
          if(audioRef.current) {
            audioRef.current.pause();
            audioRef.current.currentTime = 0;
          }
          setActiveSound(null);
          setTimeLeft(duration);
        };

        const handleStartPause = () => setIsRunning(prev => !prev);
        
        const handleSoundClick = (soundFile) => {
          if (!audioRef.current) return;
          const soundUrl = `${SUPABASE_URL}/${soundFile}`;
          
          if (activeSound === soundUrl && !audioRef.current.paused) {
            audioRef.current.pause();
            setActiveSound(null);
          } else {
            if (!audioRef.current.paused) audioRef.current.pause();
            audioRef.current.src = soundUrl;
            audioRef.current.play().then(() => setActiveSound(soundUrl)).catch(error => {
              console.error("Error playing audio:", error);
              setActiveSound(null);
            });
          }
        };
        
        const handleDragStart = (e) => {
          if (isRunning) return;
          const y = e.touches ? e.touches[0].clientY : e.clientY;
          dragStartRef.current = { y, duration };
        };

        const handleDragMove = (e) => {
          if (dragStartRef.current.y === 0 || isRunning) return;
          const y = e.touches ? e.touches[0].clientY : e.clientY;
          const deltaY = dragStartRef.current.y - y;
          const newDuration = dragStartRef.current.duration + Math.round(deltaY / 2) * 60;
          const clampedDuration = Math.max(60, Math.min(newDuration, 120 * 60));
          setDuration(clampedDuration);
        };
        
        const handleDragEnd = () => {
          dragStartRef.current = { y: 0, duration: 0 };
        };
        
        const setupScreen = h(Fragment, null,
          h('header', { className: 'flex items-center p-4 pb-2 justify-between shrink-0' },
            h('div', { className: 'flex size-12 shrink-0 items-center' }),
            h('h1', { className: 'text-white text-lg font-bold' }, 'Sesión de Enfoque'),
            h('div', { className: 'flex w-12 items-center justify-end' },
              h('button', { onClick: onClose, className: 'flex items-center justify-center rounded-xl h-12 w-12' },
                h('span', { className: 'material-symbols-outlined text-white text-3xl' }, 'close')
              )
            )
          ),
          h('main', { className: 'flex-grow flex flex-col items-center justify-center px-4' },
            h('div', { className: 'flex flex-col items-center -mt-12' },
              h('div', {
                  className: 'flex flex-col items-center justify-center',
                  onTouchStart: handleDragStart, onTouchMove: handleDragMove, onTouchEnd: handleDragEnd,
                  onMouseDown: handleDragStart, onMouseMove: handleDragMove, onMouseUp: handleDragEnd, onMouseLeave: handleDragEnd
                },
                h('div', { className: 'relative w-64 h-64 sm:w-72 sm:h-72 flex items-center justify-center' },
                  h('div', { className: 'z-10 text-center' },
                    h('h2', { className: 'text-7xl sm:text-8xl font-bold tracking-tighter text-white' }, formatTime(timeLeft))
                  )
                )
              ),
              h('div', { className: 'w-full max-w-sm -mt-4' },
                !isRunning && h('p', { className: 'text-base text-center font-normal text-white/70 mb-4' }, 'Desliza para ajustar'),
                h('button', { 
                    onClick: handleStartPause, 
                    className: 'w-full h-14 rounded-full text-white text-lg font-bold bg-white/10 backdrop-blur-md border border-white/20 hover:bg-white/20 transition-colors mb-4'
                }, 'Iniciar'),
                h('div', { className: 'grid grid-cols-3 gap-3' },
                  sounds.map(sound => {
                    const isActive = activeSound === `${SUPABASE_URL}/${sound.file}`;
                    return h('button', { 
                      key: sound.name,
                      onClick: () => handleSoundClick(sound.file),
                      className: `flex aspect-square gap-2 rounded-xl border p-2 flex-col justify-center items-center text-center cursor-pointer transition-colors ${isActive ? 'border-[#13ecda] bg-[#13ecda]/20' : 'border-white/20 bg-white/10'}`
                    },
                      h('span', { className: `material-symbols-outlined text-2xl ${isActive ? 'text-[#13ecda]' : 'text-white'}` }, sound.icon),
                      h('h2', { className: `text-sm font-bold leading-tight ${isActive ? 'text-[#13ecda]' : 'text-white'}` }, sound.name)
                    )
                  })
                )
              )
            )
          )
        );

        return h('div', {
            className: `fixed inset-0 bg-gradient-to-b from-[#2E8B57] to-[#004d40] text-white z-40 transition-transform duration-500 ease-in-out flex flex-col font-['Manrope'] ${isOpen ? 'translate-y-0' : 'translate-y-full'}`
          },
          isRunning
            ? h(ActiveTimerScreen, { timeLeft, duration, onStop: handleStop })
            : setupScreen,
          h('audio', { ref: audioRef, loop: true }),
          h('audio', { ref: endTimerAudioRef, src: `${SUPABASE_URL}/end_timer.mp3` })
        );
      }
      
      // ========== APP COMPONENT ==========
      function App() {
        const [tasks, setTasks] = useState([]);
        const [isModalOpen, setIsModalOpen] = useState(false);
        const [isFocusTimerOpen, setIsFocusTimerOpen] = useState(false);
        const [showCelebration, setShowCelebration] = useState(false);

        const predefinedTasks = ['Leer un capítulo de un libro', 'Hacer 15 minutos de ejercicio', 'Meditar por 5 minutos', 'Organizar el escritorio', 'Salir a correr', 'Llamar a un amigo o familiar', 'Beber un vaso de agua', 'Planificar el día de mañana'];

        // Cargar tareas desde localStorage al iniciar
        useEffect(() => {
          try {
            const storedTasks = localStorage.getItem('enfoke-tasks');
            if (storedTasks) setTasks(JSON.parse(storedTasks));
          } catch (e) { console.error("Failed to parse tasks from localStorage", e); }
        }, []);

        // Guardar tareas en localStorage cuando cambien
        useEffect(() => {
          localStorage.setItem('enfoke-tasks', JSON.stringify(tasks));
        }, [tasks]);

        const handleAddTask = useCallback(({ text, importance, time }) => {
          if (text.trim() && !tasks.some(t => t.text === text.trim())) {
            const newTask = { id: Date.now(), text: text.trim(), importance, time, completed: false };
            setTasks(prev => [...prev, newTask]);
          }
          setIsModalOpen(false);
        }, [tasks]);

        const handleToggleTask = useCallback(id => {
          const task = tasks.find(t => t.id === id);
          if (task && !task.completed) { setShowCelebration(true); setTimeout(() => setShowCelebration(false), 3000); }
          setTasks(prev => prev.map(t => (t.id === id ? { ...t, completed: !t.completed } : t)));
        }, [tasks]);

        const handleDeleteTask = useCallback(id => {
          setTasks(prev => prev.filter(t => t.id !== id));
        }, []);

        const handleSetImportance = useCallback((id, importance) => {
          setTasks(prev => prev.map(t => (t.id === id ? { ...t, importance } : t)));
        }, []);
        
        const handleSetTime = useCallback((id, time) => {
          setTasks(prev => prev.map(t => (t.id === id ? { ...t, time: time || null } : t)));
        }, []);

        const sortedTasks = [...tasks].sort((a, b) => (a.time || '23:59').localeCompare(b.time || '23:59'));
        
        const emptyState = h('div', { className: "flex flex-col p-2" },
            h('div', { className: "flex flex-col items-center gap-4 rounded-xl border-2 border-dashed border-white/20 px-6 py-14 bg-white/5 backdrop-blur-sm" },
                h('div', { className: "flex max-w-[480px] flex-col items-center gap-2" },
                    h('p', { className: "text-white text-lg font-bold leading-tight tracking-[-0.015em] text-center" }, 'Añade tu primera tarea'),
                    h('p', { className: "text-white/70 text-sm font-normal leading-normal text-center" }, 'Tus tareas aparecerán aquí una vez que las hayas creado.')
                )
            )
        );

        const mainContent = tasks.length > 0
          ? h('div', { className: "space-y-4 p-2" }, sortedTasks.map(task => h(TaskItem, { key: task.id, task, onToggle: handleToggleTask, onDelete: handleDeleteTask, onSetImportance: handleSetImportance, onSetTime: handleSetTime })))
          : emptyState;

        return h('div', { className: "relative min-h-screen w-full text-white flex flex-col font-['Manrope']" },
            h('div', { className: `transition-transform duration-500 ease-in-out h-full flex flex-col ${isFocusTimerOpen ? '-translate-y-full' : 'translate-y-0'}`},
                h('header', { className: 'flex items-center p-4 pt-6 pb-2 justify-center' },
                    h('h1', { className: 'text-white text-lg font-bold tracking-[-0.015em]' }, 'ENFOKE')
                ),
                h('main', { className: 'flex flex-1 flex-col px-4 pt-4 overflow-y-auto' },
                    h('div', { className: 'px-2 py-3' },
                        h('button', {
                            onClick: () => setIsModalOpen(true),
                            'aria-label': 'Añadir nueva tarea',
                            className: 'flex w-full min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-12 px-5 bg-[#13ecda] text-[#102220] text-base font-bold tracking-[0.015em]'
                        }, h('span', { className: 'truncate' }, 'Añadir tarea'))
                    ),
                    mainContent
                )
            ),
            h('footer', { className: `sticky bottom-0 flex justify-center items-center p-5 z-30 transition-all duration-300 ease-in-out ${isFocusTimerOpen ? 'opacity-0 translate-y-full' : 'opacity-100 translate-y-0'}` },
                h('button', {
                    onClick: () => setIsFocusTimerOpen(true),
                    title: 'Modo Concentración',
                    className: 'flex h-16 w-16 cursor-pointer items-center justify-center overflow-hidden rounded-full bg-[#13ecda] text-[#102220] shadow-lg shadow-[#13ecda]/20'
                }, h(BrainIcon, { className: 'w-10 h-10' }))
            ),
            h(SuggestedTasksModal, { isOpen: isModalOpen, onClose: () => setIsModalOpen(false), onConfirm: handleAddTask, suggestions: predefinedTasks }),
            h(CelebrationAnimation, { show: showCelebration }),
            h(FocusTimer, { isOpen: isFocusTimerOpen, onClose: () => setIsFocusTimerOpen(false) })
        );
      }
      
      // ========== RENDER APP ==========
      const rootElement = document.getElementById('root');
      if (rootElement) {
        const root = ReactDOM.createRoot(rootElement);
        root.render(h(App));
      } else {
        console.error('Root element #root not found in the document.');
      }
    })();
  </script>
</body>
</html>